version: '3.8'

services:
  # OrtoPed scanner service
  ortoped:
    build:
      context: .
      dockerfile: Dockerfile
    image: ortoped:latest
    container_name: ortoped-scanner
    volumes:
      # Mount your project directory (read-only)
      - ./projects:/projects:ro
      # Mount directory for scan reports
      - ./reports:/reports
    environment:
      # Required for AI license resolution
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    # Default command: scan the mounted project
    command: scan -p /projects/myproject -o /reports/ortoped-report.json

  # Example: Scan with policy evaluation
  ortoped-policy:
    build:
      context: .
      dockerfile: Dockerfile
    image: ortoped:latest
    container_name: ortoped-policy
    volumes:
      - ./projects:/projects:ro
      - ./reports:/reports
      - ./examples:/policies:ro
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    command: |
      sh -c "
        /app/bin/ortoped scan -p /projects/myproject -o /reports/scan.json &&
        /app/bin/ortoped policy -i /reports/scan.json -p /policies/default-policy.yaml -o /reports/policy-report.json
      "
    profiles:
      - policy

  # Example: Generate SBOM
  ortoped-sbom:
    build:
      context: .
      dockerfile: Dockerfile
    image: ortoped:latest
    container_name: ortoped-sbom
    volumes:
      - ./reports:/reports
    command: sbom -i /reports/scan.json -f cyclonedx-json -o /reports/project.cdx.json
    profiles:
      - sbom

# Default network
networks:
  default:
    name: ortoped-network
